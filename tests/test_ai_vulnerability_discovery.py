import pytest
from ai_vulnerability_discovery import AIVulnerabilityDiscovery, VulnerabilityPattern


def test_fstring_sql_injection_is_found():
    """
    Tests that the fixed engine correctly detects SQL injection in f-strings.
    This test will fail until the fix is implemented.
    """
    vulnerable_code = """
import sqlite3

def get_user(user_id: str):
    conn = sqlite3.connect(":memory:")
    cursor = conn.cursor()
    query = f"SELECT * FROM users WHERE id = '{user_id}'"
    cursor.execute(query)
    return cursor.fetchone()
"""
    engine = AIVulnerabilityDiscovery()
    results = engine.discover_vulnerabilities(vulnerable_code)

    assert results["summary"]["total_vulnerabilities"] == 1
    sql_injection_vuln = results["static_analysis"][0]
    assert sql_injection_vuln["pattern"] == VulnerabilityPattern.SQL_INJECTION
    assert sql_injection_vuln["severity"] == "critical"


def test_xss_vulnerability_is_found():
    """
    Tests that the engine correctly detects a reflected XSS vulnerability.
    """
    vulnerable_code = """
from flask import Flask, request, Markup

app = Flask(__name__)

@app.route("/search")
def search():
    query = request.args.get("q")
    return Markup(f"<h1>Search results for: {query}</h1>")
"""
    engine = AIVulnerabilityDiscovery()
    results = engine.discover_vulnerabilities(vulnerable_code)

    assert results["summary"]["total_vulnerabilities"] > 0
    xss_vuln = [
        v for v in results["static_analysis"] if v["pattern"] == VulnerabilityPattern.XSS
    ]
    assert len(xss_vuln) > 0
    assert xss_vuln[0]["severity"] == "high"


def test_taint_analysis_command_injection():
    """
    Tests that the AST-based taint analysis correctly identifies a command injection vulnerability.
    This test will fail with the old regex-based implementation.
    """
    vulnerable_code = """
import os
from flask import request

@app.route("/files")
def list_files():
    directory = request.args.get("dir")
    command = "ls -l " + directory
    os.system(command)
"""
    engine = AIVulnerabilityDiscovery()
    results = engine.discover_vulnerabilities(vulnerable_code, "vulnerable_app/app.py")

    assert len(results["dataflow_analysis"]) == 1
    flow = results["dataflow_analysis"][0]
    assert flow["vulnerability_pattern"] == "command_injection"
    assert flow["sink_function"] == "os.system"
